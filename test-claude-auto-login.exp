#!/usr/bin/expect -f

# Claude Code Login Automation Script
set timeout 60

puts "========================================="
puts "Claude Code Automated Login Test"
puts "========================================="
puts ""

# Step 1: Clean up first
puts "Step 1: Cleaning up existing authentication..."
catch {exec pkill -f claude}
catch {exec security delete-generic-password -s "Claude Code-credentials"}
puts "  ‚úì Cleaned up existing auth"

# Step 2: Start Claude
puts "\nStep 2: Starting Claude..."
spawn claude

# Step 3: Handle initial interaction
expect {
    "Choose the text style" {
        puts "\n=== THEME SELECTION DETECTED ==="
        puts "  ‚Üí Pressing Enter for default (Dark mode)..."
        send "\r"
        exp_continue
    }
    "Welcome to Claude Code" {
        puts "\n=== CLAUDE STARTED SUCCESSFULLY ==="

        # Wait a moment for UI to stabilize
        sleep 2

        # Step 4: Send /login command
        puts "\nStep 3: Initiating login..."
        puts "  ‚Üí Sending /login command..."
        send "/login\r"

        # Now wait for login prompt
        expect {
            "Select login method" {
                puts "\n=== LOGIN METHOD PROMPT DETECTED ==="
                puts "  ‚Üí Selecting option 1 (Anthropic account)..."
                sleep 1
                send "1\r"

                # Wait for browser URL
                expect {
                    -re {(https://[^\s\)\]]+)} {
                        set url $expect_out(1,string)
                        puts "\n========================================="
                        puts "üéâ SUCCESS! Authentication URL detected:"
                        puts "URL: $url"
                        puts "========================================="

                        # Open browser
                        puts "\nOpening browser..."
                        catch {exec open "$url"}
                        puts "  ‚úì Browser command sent"

                        # Give time for browser to open
                        sleep 3

                        puts "\nLogin flow completed successfully!"
                        send "/exit\r"
                    }
                    timeout {
                        puts "\n‚ö†Ô∏è  No URL detected within timeout"
                        send "/exit\r"
                    }
                }
            }
            -re "\\[1\\].*Anthropic" {
                puts "\n=== LOGIN OPTIONS DETECTED ==="
                puts "  ‚Üí Selecting option 1 (Anthropic)..."
                send "1\r"
                exp_continue
            }
            timeout {
                puts "\n‚ö†Ô∏è  No login prompt appeared"
                puts "Claude might already be authenticated"
                send "/exit\r"
            }
        }
    }
    timeout {
        puts "\n‚ö†Ô∏è  Claude did not start properly"
    }
}

expect eof
puts "\n========================================="
puts "Test complete!"
puts "========================================="