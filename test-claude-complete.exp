#!/usr/bin/expect -f

# Claude Code Complete Login Flow Test
set timeout 60

puts "========================================="
puts "Claude Code - Complete Login Flow Test"
puts "========================================="
puts ""

# Clean up
catch {exec pkill -f claude}
catch {exec security delete-generic-password -s "Claude Code-credentials"}
puts "Cleaned up existing authentication\n"

puts "Starting Claude..."
spawn claude

expect {
    "Choose the text style" {
        puts "‚Üí Theme selection: Pressing Enter for Dark mode"
        send "\r"
        exp_continue
    }
    "Select login method" {
        puts "\n‚úÖ LOGIN METHOD SCREEN APPEARED!"
        puts "‚Üí Pressing Enter to select option 1 (Claude account)"
        send "\r"

        puts "\nWaiting for authentication to start..."
        expect {
            -re {Opening.*browser} {
                puts "\n‚úÖ Browser opening message detected!"
                exp_continue
            }
            -re {(https://[^\s\)\]]+)} {
                set url $expect_out(1,string)
                puts "\n========================================="
                puts "üéâ SUCCESS! Authentication URL detected:"
                puts "URL: $url"
                puts "========================================="

                puts "\n‚Üí Opening browser..."
                catch {exec open "$url"}
                puts "‚úÖ Browser command executed!"
                puts "\nThe browser should now be opening with the login page."
                puts "Complete the login in your browser to authenticate Claude Code."

                sleep 10
                send "\003"  ;# Ctrl+C to exit
            }
            "Please open" {
                puts "\n‚úÖ Manual browser open instruction detected"
                exp_continue
            }
            "visit" {
                puts "\n‚úÖ Visit URL instruction detected"
                exp_continue
            }
            timeout {
                puts "\n‚ö†Ô∏è  No browser URL detected within timeout"
                puts "Claude might need additional interaction"
            }
        }
    }
    timeout {
        puts "‚ö†Ô∏è  Initial timeout reached"
    }
}

expect eof
puts "\n========================================="
puts "Test complete!"
puts "========================================="