#!/usr/bin/expect -f

# Claude Code Full Login with Browser Test
set timeout 60

puts "========================================="
puts "Claude Code - Testing Browser Launch"
puts "========================================="
puts ""

# Clean up
catch {exec pkill -f claude}
catch {exec security delete-generic-password -s "Claude Code-credentials"}

puts "Starting Claude fresh..."
spawn claude

expect {
    "Choose the text style" {
        puts "‚Üí Theme selection: Pressing Enter for Dark mode"
        send "\r"
        exp_continue
    }
    "Select login method" {
        puts "\n‚úÖ LOGIN METHOD SCREEN APPEARED!"
        puts "‚Üí Selecting option 1 (Claude account with subscription)"
        send "1\r"

        puts "\nWaiting for browser URL..."
        expect {
            -re {(https://[^\s\)\]]+)} {
                set url $expect_out(1,string)
                puts "\n========================================="
                puts "üéâ SUCCESS! Browser URL detected:"
                puts "URL: $url"
                puts "========================================="

                puts "\n‚Üí Opening browser..."
                catch {exec open "$url"}
                puts "‚úÖ Browser should be opening now!"

                sleep 5
                send "\003"  ;# Ctrl+C to exit
            }
            timeout {
                puts "‚ö†Ô∏è  No browser URL detected"
            }
        }
    }
    timeout {
        puts "‚ö†Ô∏è  Timeout reached"
    }
}

expect eof
puts "\n‚úÖ Test complete!"